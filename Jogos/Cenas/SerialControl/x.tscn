[gd_scene load_steps=5 format=2]

[ext_resource path="res://Cenas/SerialControl/Com.gd" type="Script" id=2]
[ext_resource path="res://Fontes/Fontes_Formatadas/Botoes.tres" type="DynamicFont" id=3]
[ext_resource path="res://Fontes/Fontes_Formatadas/insideDropdownAndLineEdit.tres" type="DynamicFont" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

const SERCOMM = preload(\"res://bin/GDsercomm.gdns\")
onready var PORT = SERCOMM.new()

#helper node
onready var com=$Com 
#use it as node since script alone won't have the editor help

var port = 1

func _ready():
	#adding the baudrates options
	$OptionButton.add_item(\"\")
	for index in com.baud_list: #first use of com helper
		$OptionButton.add_item(str(index))

#_physics_process may lag with lots of characters, but is the simplest way
#for best speed, you can use a thread
#do not use _process due to fps being too high
func _physics_process(_delta): 
	if PORT.get_available()>0:
		for _i in range(PORT.get_available()):
			$Title.text = PORT.read()

func _on_SendButton_pressed():
	send_text()

func _on_OptionButton_item_selected(ID):
	set_physics_process(false)
	PORT.close()
	if port!=null and ID!=0:
		#PORT.open(\"/dev/ttyUSB1\",115200,1000)
		PORT.open(\"COM6\",115200,1000)
	else:
		print(\"You must select a port first\")
	set_physics_process(true)

func _on_UpdateButton_pressed(): #Updates the port list
	$PortList.clear()
	$PortList.add_item(\"Select Port\")
	for index in PORT.list_ports():
		$PortList.add_item(str(index))

func _on_PortList_item_selected(ID):
	port=$PortList.get_item_text(ID)
	$OptionButton.select(0)

func _on_LineEdit_gui_input(ev):
	if ev is InputEventKey and ev.scancode==KEY_ENTER:
		if($LineEdit.text!=\"\"): #due to is_echo not working for some reason
			send_text()

func send_text():
	#LineEdit does not recognize endline
	var text=$LineEdit.text.replace((\"\\\\n\"),com.endline)

	if $CheckBox.pressed: #if checkbox is active, add endline
		text+=com.endline

	PORT.write(text) #write function, please use only ascii
	$LineEdit.text=\"\"
"

[node name="Control" type="Control"]
margin_left = 767.0
margin_top = 1.0
margin_right = 767.0
margin_bottom = 1.0
script = SubResource( 1 )

[node name="LineEdit" type="LineEdit" parent="."]
margin_left = -491.0
margin_top = 309.888
margin_right = -433.0
margin_bottom = 343.888

[node name="SendButton" type="Button" parent="."]
margin_left = -420.0
margin_top = 316.888
margin_right = -361.0
margin_bottom = 336.888
text = "Send"

[node name="OptionButton" type="OptionButton" parent="."]
light_mask = 7
margin_left = -147.0
margin_top = 318.0
margin_right = -37.0
margin_bottom = 338.0
hint_tooltip = "Baudrate selection is what will open the port
"
toggle_mode = false

[node name="Baudrate" type="Label" parent="."]
light_mask = 7
margin_left = -227.0
margin_top = 322.0
margin_right = -152.0
margin_bottom = 336.0
text = "Baudrate:"
uppercase = true

[node name="Com" type="Node" parent="."]
script = ExtResource( 2 )

[node name="UpdateButton" type="Button" parent="."]
light_mask = 7
margin_left = 603.0
margin_top = 541.0
margin_right = 1003.0
margin_bottom = 621.0
hint_tooltip = "Refresh Port list"
custom_fonts/font = ExtResource( 3 )
text = "Atualizar portas"

[node name="PortList" type="OptionButton" parent="."]
light_mask = 7
margin_left = -408.0
margin_top = 677.0
margin_right = 552.0
margin_bottom = 812.0
custom_fonts/font = ExtResource( 4 )
toggle_mode = false

[node name="RichTextLabel" type="RichTextLabel" parent="."]
margin_left = -497.0
margin_top = 364.0
margin_right = -106.0
margin_bottom = 605.0
bbcode_enabled = true
scroll_following = true

[node name="CheckBox" type="CheckBox" parent="."]
margin_left = -343.0
margin_top = 316.0
margin_right = -252.0
margin_bottom = 342.0
hint_tooltip = "Adds endline at the end of the text sended
"
text = "w/endline"

[node name="Title" type="Label" parent="."]
margin_left = -495.0
margin_top = 277.0
margin_right = -340.0
margin_bottom = 296.0
text = "BASIC SERIAL MONITOR"

[node name="dir" type="Label" parent="."]
margin_left = -386.0
margin_top = 365.0
margin_right = -346.0
margin_bottom = 379.0

[connection signal="gui_input" from="LineEdit" to="." method="_on_LineEdit_gui_input"]
[connection signal="pressed" from="SendButton" to="." method="_on_SendButton_pressed"]
[connection signal="item_selected" from="OptionButton" to="." method="_on_OptionButton_item_selected"]
[connection signal="pressed" from="UpdateButton" to="." method="_on_UpdateButton_pressed"]
[connection signal="item_selected" from="PortList" to="." method="_on_PortList_item_selected"]
